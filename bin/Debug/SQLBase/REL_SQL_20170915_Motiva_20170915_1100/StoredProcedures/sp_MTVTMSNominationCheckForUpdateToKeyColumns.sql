/*
*****************************************************************************************************
USE FIND AND REPLACE ON sp_MTVTMSNominationCheckForUpdateToKeyColumns WITH YOUR view (NOTE:  sp_ is already set
*****************************************************************************************************
*/

/****** Object:  StoredProcedure [dbo].[sp_MTVTMSNominationCheckForUpdateToKeyColumns]   Script Date: DATECREATED ******/
PRINT 'Start Script=[sp_MTVTMSNominationCheckForUpdateToKeyColumns].sql  Domain=  Time=' + CONVERT(VARCHAR(50), GETDATE(), 109) + ' on ' + @@SERVERNAME+'.'+db_name()
GO

IF  OBJECT_ID(N'[dbo].[sp_MTVTMSNominationCheckForUpdateToKeyColumns]') IS NULL
      BEGIN
			EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[sp_MTVTMSNominationCheckForUpdateToKeyColumns] AS SELECT 1'
			PRINT '<<< CREATED StoredProcedure [sp_MTVTMSNominationCheckForUpdateToKeyColumns] >>>'
	  END
GO
--select * from mtvtmsaccounttotmsstaging where plnndmvtid = 4634
--select * from mtvtmsnominationstaging where order_no = 4634
/****** Object:  StoredProcedure [dbo].[sp_MTVTMSNominationCheckForUpdateToKeyColumns]    Script Date: 5/16/2016 11:48:12 PM ******/
--exec sp_MTVTMSNominationCheckForUpdateToKeyColumns 359198,4634
alter procedure dbo.sp_MTVTMSNominationCheckForUpdateToKeyColumns 
(  @TMSFileIdnty int,  @orderid int )
AS

Declare @rowcount int
Declare @LastTMSFileIdnty int
Declare @action char(1)
Declare @sequence int


			  --if you are calling this stored procedure then your nomAction was either a'D' or 'U' meaning a valid nomination was already sent to tms
			  --this means check the existing data that was sent to TMS and see if your primary key of orderid,cust_no has changed
			  --if you don't find cust_no then take the existing data from tmsnominationstaging and insert it with the new
			  --tmsfileidnty number as a delete
			 select @sequence =  isnull(min( sequence ),1) from dbo.MTVTMSNominationStaging where order_no  in (select plnndmvtid from dbo.MTVTMSAccountToTmsStaging where TMSFileIdnty = @TMSFileIdnty )

			 while @sequence is not null

			  begin

			  select @LastTMSFileIdnty = ( 
			     select max(nom.TMSFileIdnty)
			      from dbo.MTVTMSNominationStaging nom
				       inner join dbo.MTVTMSAccountToTmsStaging MA on MA.TMSFileIdnty = nom.TMSFileIdnty
			                                                      and MA.InterfaceStatus = 'C'
			                                                      and MA.IsDataChanged = 'Y'
			      where MA.PlnndMvtID = @orderid
				    and isnull(nom.Sequence,1) = @sequence
				    
				  )
			        
			        
			        
			  --select @LastTMSFileIdnty = (Select ISNULL(Max(mats.TMSFileIdnty),0) TMSFileIdnty 
     --                             From MTVTMSAccountToTmsStaging mats
     --                                  inner join MTVTMSNominationStaging mns on mns.TMSFileIdnty = mats.TMSFileIdnty                                                                             
     --                             where mats.IsDataChanged='Y' and isnull(mats.InterfaceStatus,'') = 'C' 
     --                                 and mats.plnndmvtid = ( Select mats2.plnndmvtid from MTVTMSAccountToTmsStaging mats2 where mats2.tmsfileidnty = @TMSFileIdnty)
     --                                 and isnull(mns.sequence,0) = ( Select isnull(mns2.sequence,0) from MTVTMSNominationStaging mns2 where mns2.tmsfileidnty = @TMSFileIdnty)      
			 
			  --                          )
			  
			  Select @action = ( Select PlnndMvtStts From PlannedMovement where PlnndMvtID = @orderid )      
			        
			  -- you should have a tmsfileidnty 
			  if @LastTMSFileIdnty is not null and @action <> 'I'
			  begin

			     set @rowcount = 0
			     Insert into dbo.MTVTMSNominationStaging
				 (  TMSFileIdnty,recdel, action, rec_type, supplier_no, order_no, term_id, cust_no, acct_no, destination_no, order_status, order_comments, sched_date, order_date, order_time, po_number, release_no, total_qty, driver_no, carrier_no, truck_no, trailer1, trailer2, shift, delv_seq_no, disp_comments, dest, flood_load, load_seq_no, processed, load_date, load_start, load_stop, supplier_rack_no, petroex_consignee, additional_doc, truck_driver, seal1, seal2, preload_enabled, enable_ship_to_plan, filler, trailer_A1, compartment_A1, flood_group_A1, prod_id_A1, Order_qty_A1, retained_A1, loaded_A1, returned_A1, status_A1, seal_no_A1, driver_adjusted_A1, auto_adjusted_A1, filler_A1, trailer_A2, compartment_A2, flood_group_A2, prod_id_A2, Order_qty_A2, retained_A2, loaded_A2, returned_A2, status_A2, seal_no_A2, driver_adjusted_A2, auto_adjusted_A2, filler_A2, trailer_A3, compartment_A3, flood_group_A3, prod_id_A3, Order_qty_A3, retained_A3, loaded_A3, returned_A3, status_A3, seal_no_A3, driver_adjusted_A3, auto_adjusted_A3, filler_A3,
				    trailer_A4, compartment_A4, flood_group_A4, prod_id_A4, Order_qty_A4, retained_A4, loaded_A4, returned_A4, status_A4, seal_no_A4, driver_adjusted_A4, auto_adjusted_A4, filler_A4, trailer_A5, compartment_A5, flood_group_A5, prod_id_A5, Order_qty_A5, retained_A5, loaded_A5, returned_A5, status_A5, seal_no_A5, driver_adjusted_A5, auto_adjusted_A5, filler_A5, trailer_A6, compartment_A6, flood_group_A6, prod_id_A6, Order_qty_A6, retained_A6, loaded_A6, returned_A6, status_A6, seal_no_A6, driver_adjusted_A6, auto_adjusted_A6, filler_A6, trailer_A7, compartment_A7, flood_group_A7, prod_id_A7, Order_qty_A7, retained_A7, loaded_A7, returned_A7, status_A7, seal_no_A7, driver_adjusted_A7, auto_adjusted_A7, filler_A7, trailer_A8, compartment_A8, flood_group_A8, prod_id_A8, Order_qty_A8, retained_A8, loaded_A8, returned_A8, status_A8, seal_no_A8, driver_adjusted_A8, auto_adjusted_A8, filler_A8, trailer_A9, compartment_A9, flood_group_A9, prod_id_A9, Order_qty_A9, retained_A9, loaded_A9, returned_A9, status_A9, seal_no_A9, driver_adjusted_A9, auto_adjusted_A9, filler_A9, 
					trailer_A10, compartment_A10, flood_group_A10, prod_id_A10, Order_qty_A10, retained_A10, loaded_A10, returned_A10, status_A10, seal_no_A10, driver_adjusted_A10, auto_adjusted_A10, filler_A10, trailer_A11, compartment_A11, flood_group_A11, prod_id_A11, Order_qty_A11, retained_A11, loaded_A11, returned_A11, status_A11, seal_no_A11, driver_adjusted_A11, auto_adjusted_A11, filler_A11, trailer_A12, compartment_A12, flood_group_A12, prod_id_A12, Order_qty_A12, retained_A12, loaded_A12, returned_A12, status_A12, seal_no_A12, driver_adjusted_A12, auto_adjusted_A12, filler_A12, host_order_no, sys_movement_id_A1, line_item_date_A1, line_item_time_A1, sys_movement_id_A2, line_item_date_A2, line_item_time_A2, sys_movement_id_A3, line_item_date_A3, line_item_time_A3, sys_movement_id_A4, line_item_date_A4, line_item_time_A4, sys_movement_id_A5, line_item_date_A5, line_item_time_A5, sys_movement_id_A6, line_item_date_A6, line_item_time_A6, sys_movement_id_A7, line_item_date_A7, line_item_time_A7, sys_movement_id_A8, line_item_date_A8, line_item_time_A8, sys_movement_id_A9, line_item_date_A9, line_item_time_A9, sys_movement_id_A10, line_item_date_A10, line_item_time_A10, sys_movement_id_A11, line_item_date_A11, line_item_time_A11, sys_movement_id_A12, line_item_date_A12, line_item_time_A12, limit_order, verify_carrier, sched_time, trans_id, contract_number, selected_prod_id, exp_date, exp_time, tare_wgt, folio_mo, folio_no, inv_no, host_po_number, UOM, trans_seq_no,
				    delv_zone, distance, delv_date, delv_time, load_configrmed, dispatch_customer_tupe, validate_pidx_consignee, date_added, TmsNominationType, sequence,
					nominationline)
				 Select @TMSFileIdnty, recdel, 'D', rec_type, supplier_no, order_no, term_id, cust_no, acct_no, destination_no, order_status, order_comments, sched_date, order_date, order_time, po_number, release_no, total_qty, driver_no, carrier_no, truck_no, trailer1, trailer2, shift, delv_seq_no, disp_comments, dest, flood_load, load_seq_no, processed, load_date, load_start, load_stop, supplier_rack_no, petroex_consignee, additional_doc, truck_driver, seal1, seal2, preload_enabled, enable_ship_to_plan, filler, trailer_A1, compartment_A1, flood_group_A1, prod_id_A1, Order_qty_A1, retained_A1, loaded_A1, returned_A1, status_A1, seal_no_A1, driver_adjusted_A1, auto_adjusted_A1, filler_A1, trailer_A2, compartment_A2, flood_group_A2, prod_id_A2, Order_qty_A2, retained_A2, loaded_A2, returned_A2, status_A2, seal_no_A2, driver_adjusted_A2, auto_adjusted_A2, filler_A2, trailer_A3, compartment_A3, flood_group_A3, prod_id_A3, Order_qty_A3, retained_A3, loaded_A3, returned_A3, status_A3, seal_no_A3, driver_adjusted_A3, auto_adjusted_A3, filler_A3,
				    trailer_A4, compartment_A4, flood_group_A4, prod_id_A4, Order_qty_A4, retained_A4, loaded_A4, returned_A4, status_A4, seal_no_A4, driver_adjusted_A4, auto_adjusted_A4, filler_A4, trailer_A5, compartment_A5, flood_group_A5, prod_id_A5, Order_qty_A5, retained_A5, loaded_A5, returned_A5, status_A5, seal_no_A5, driver_adjusted_A5, auto_adjusted_A5, filler_A5, trailer_A6, compartment_A6, flood_group_A6, prod_id_A6, Order_qty_A6, retained_A6, loaded_A6, returned_A6, status_A6, seal_no_A6, driver_adjusted_A6, auto_adjusted_A6, filler_A6, trailer_A7, compartment_A7, flood_group_A7, prod_id_A7, Order_qty_A7, retained_A7, loaded_A7, returned_A7, status_A7, seal_no_A7, driver_adjusted_A7, auto_adjusted_A7, filler_A7, trailer_A8, compartment_A8, flood_group_A8, prod_id_A8, Order_qty_A8, retained_A8, loaded_A8, returned_A8, status_A8, seal_no_A8, driver_adjusted_A8, auto_adjusted_A8, filler_A8, trailer_A9, compartment_A9, flood_group_A9, prod_id_A9, Order_qty_A9, retained_A9, loaded_A9, returned_A9, status_A9, seal_no_A9, driver_adjusted_A9, auto_adjusted_A9, filler_A9, 
					trailer_A10, compartment_A10, flood_group_A10, prod_id_A10, Order_qty_A10, retained_A10, loaded_A10, returned_A10, status_A10, seal_no_A10, driver_adjusted_A10, auto_adjusted_A10, filler_A10, trailer_A11, compartment_A11, flood_group_A11, prod_id_A11, Order_qty_A11, retained_A11, loaded_A11, returned_A11, status_A11, seal_no_A11, driver_adjusted_A11, auto_adjusted_A11, filler_A11, trailer_A12, compartment_A12, flood_group_A12, prod_id_A12, Order_qty_A12, retained_A12, loaded_A12, returned_A12, status_A12, seal_no_A12, driver_adjusted_A12, auto_adjusted_A12, filler_A12, host_order_no, sys_movement_id_A1, line_item_date_A1, line_item_time_A1, sys_movement_id_A2, line_item_date_A2, line_item_time_A2, sys_movement_id_A3, line_item_date_A3, line_item_time_A3, sys_movement_id_A4, line_item_date_A4, line_item_time_A4, sys_movement_id_A5, line_item_date_A5, line_item_time_A5, sys_movement_id_A6, line_item_date_A6, line_item_time_A6, sys_movement_id_A7, line_item_date_A7, line_item_time_A7, sys_movement_id_A8, line_item_date_A8, line_item_time_A8, sys_movement_id_A9, line_item_date_A9, line_item_time_A9, sys_movement_id_A10, line_item_date_A10, line_item_time_A10, sys_movement_id_A11, line_item_date_A11, line_item_time_A11, sys_movement_id_A12, line_item_date_A12, line_item_time_A12, limit_order, verify_carrier, sched_time, trans_id, contract_number, selected_prod_id, exp_date, exp_time, tare_wgt, folio_mo, folio_no, inv_no, host_po_number, UOM, trans_seq_no,
				    delv_zone, distance, delv_date, delv_time, load_configrmed, dispatch_customer_tupe, validate_pidx_consignee, date_added, TmsNominationType, sequence,
					 recdel + 'D' + rec_type + supplier_no + order_no + term_id + cust_no + acct_no + destination_no + order_status + order_comments + sched_date + order_date + order_time + po_number + release_no + total_qty + driver_no + carrier_no + truck_no + trailer1 + trailer2 + shift + delv_seq_no + disp_comments + dest + flood_load + load_seq_no + processed + load_date + load_start + load_stop + supplier_rack_no + petroex_consignee + additional_doc + truck_driver + seal1 + seal2 + preload_enabled + enable_ship_to_plan + filler + trailer_A1 + compartment_A1 + flood_group_A1 + prod_id_A1 + Order_qty_A1 + retained_A1 + loaded_A1 + returned_A1 + status_A1 + seal_no_A1 + driver_adjusted_A1 + auto_adjusted_A1 + filler_A1 + trailer_A2 + compartment_A2 + flood_group_A2 + prod_id_A2 + Order_qty_A2 + retained_A2 + loaded_A2 + returned_A2 + status_A2 + seal_no_A2 + driver_adjusted_A2 + auto_adjusted_A2 + filler_A2 + trailer_A3 + compartment_A3 + flood_group_A3 + prod_id_A3 + Order_qty_A3 + retained_A3 + loaded_A3 + returned_A3 + status_A3 + seal_no_A3 + driver_adjusted_A3 + auto_adjusted_A3 + filler_A3 + trailer_A4 + compartment_A4 + flood_group_A4 + prod_id_A4 + Order_qty_A4 + retained_A4 + loaded_A4 + returned_A4 + status_A4 + seal_no_A4 + driver_adjusted_A4 + auto_adjusted_A4 + filler_A4 + trailer_A5 + compartment_A5 + flood_group_A5 + prod_id_A5 + Order_qty_A5 + retained_A5 + loaded_A5 + returned_A5 + status_A5 + seal_no_A5 + driver_adjusted_A5 + auto_adjusted_A5 + filler_A5 + trailer_A6 + compartment_A6 + flood_group_A6 + prod_id_A6 + Order_qty_A6 + retained_A6 + loaded_A6 + returned_A6 + status_A6 + seal_no_A6 + driver_adjusted_A6 + auto_adjusted_A6 + filler_A6 + trailer_A7 + compartment_A7 + flood_group_A7 + prod_id_A7 + Order_qty_A7 + retained_A7 + loaded_A7 + returned_A7 + status_A7 + seal_no_A7 + driver_adjusted_A7 + auto_adjusted_A7 + filler_A7 + trailer_A8 + compartment_A8 + flood_group_A8 + prod_id_A8 + Order_qty_A8 + retained_A8 + loaded_A8 + returned_A8 + status_A8 + seal_no_A8 + driver_adjusted_A8 + auto_adjusted_A8 + filler_A8 + trailer_A9 + compartment_A9 + flood_group_A9 + prod_id_A9 + Order_qty_A9 + retained_A9 + loaded_A9 + returned_A9 + status_A9 + seal_no_A9 + driver_adjusted_A9 + auto_adjusted_A9 + filler_A9 + trailer_A10 + compartment_A10 + flood_group_A10 + prod_id_A10 + Order_qty_A10 + retained_A10 + loaded_A10 + returned_A10 + status_A10 + seal_no_A10 + driver_adjusted_A10 + auto_adjusted_A10 + filler_A10 + trailer_A11 + compartment_A11 + flood_group_A11 + prod_id_A11 + Order_qty_A11 + retained_A11 + loaded_A11 + returned_A11 + status_A11 + seal_no_A11 + driver_adjusted_A11 + auto_adjusted_A11 + filler_A11 + trailer_A12 + compartment_A12 + flood_group_A12 + prod_id_A12 + Order_qty_A12 + retained_A12 + loaded_A12 + returned_A12 + status_A12 + seal_no_A12 + driver_adjusted_A12 + auto_adjusted_A12 + filler_A12 + host_order_no + sys_movement_id_A1 + line_item_date_A1 + line_item_time_A1 + sys_movement_id_A2 + line_item_date_A2 + line_item_time_A2 + sys_movement_id_A3 + line_item_date_A3 + line_item_time_A3 + sys_movement_id_A4 + line_item_date_A4 + line_item_time_A4 + sys_movement_id_A5 + line_item_date_A5 + line_item_time_A5 + sys_movement_id_A6 + line_item_date_A6 + line_item_time_A6 + sys_movement_id_A7 + line_item_date_A7 + line_item_time_A7 + sys_movement_id_A8 + line_item_date_A8 + line_item_time_A8 + sys_movement_id_A9 + line_item_date_A9 + line_item_time_A9 + sys_movement_id_A10 + line_item_date_A10 + line_item_time_A10 + sys_movement_id_A11 + line_item_date_A11 + line_item_time_A11 + sys_movement_id_A12 + line_item_date_A12 + line_item_time_A12 + limit_order + verify_carrier + sched_time + trans_id + contract_number + selected_prod_id + exp_date + exp_time + tare_wgt + folio_mo + folio_no + inv_no + host_po_number + UOM + trans_seq_no + delv_zone + distance + delv_date + delv_time + load_configrmed + dispatch_customer_tupe + validate_pidx_consignee + date_added

				 From dbo.MTVTMSNominationStaging MA
				 Where MA.TMSFileIdnty = @LastTMSFileIdnty
				   and isnull(MA.sequence,1) = isnull(@sequence,1)
				   and MA.Action <> 'D'
				   and MA.cust_no not in ( select MA2.cust_no From dbo.MTVTMSNominationStaging MA2 where MA2.TMSFileIdnty = @TMSFileIdnty and MA2.sequence = MA.sequence )
				 set @rowcount = @@rowcount
				end

			  if @LastTMSFileIdnty is not null and @action = 'I'
			  begin

			        set @rowcount = 0
			        Insert into dbo.MTVTMSNominationStaging
				    (  TMSFileIdnty,recdel, action, rec_type, supplier_no, order_no, term_id, cust_no, acct_no, destination_no, order_status, order_comments, sched_date, order_date, order_time, po_number, release_no, total_qty, driver_no, carrier_no, truck_no, trailer1, trailer2, shift, delv_seq_no, disp_comments, dest, flood_load, load_seq_no, processed, load_date, load_start, load_stop, supplier_rack_no, petroex_consignee, additional_doc, truck_driver, seal1, seal2, preload_enabled, enable_ship_to_plan, filler, trailer_A1, compartment_A1, flood_group_A1, prod_id_A1, Order_qty_A1, retained_A1, loaded_A1, returned_A1, status_A1, seal_no_A1, driver_adjusted_A1, auto_adjusted_A1, filler_A1, trailer_A2, compartment_A2, flood_group_A2, prod_id_A2, Order_qty_A2, retained_A2, loaded_A2, returned_A2, status_A2, seal_no_A2, driver_adjusted_A2, auto_adjusted_A2, filler_A2, trailer_A3, compartment_A3, flood_group_A3, prod_id_A3, Order_qty_A3, retained_A3, loaded_A3, returned_A3, status_A3, seal_no_A3, driver_adjusted_A3, auto_adjusted_A3, filler_A3,
				       trailer_A4, compartment_A4, flood_group_A4, prod_id_A4, Order_qty_A4, retained_A4, loaded_A4, returned_A4, status_A4, seal_no_A4, driver_adjusted_A4, auto_adjusted_A4, filler_A4, trailer_A5, compartment_A5, flood_group_A5, prod_id_A5, Order_qty_A5, retained_A5, loaded_A5, returned_A5, status_A5, seal_no_A5, driver_adjusted_A5, auto_adjusted_A5, filler_A5, trailer_A6, compartment_A6, flood_group_A6, prod_id_A6, Order_qty_A6, retained_A6, loaded_A6, returned_A6, status_A6, seal_no_A6, driver_adjusted_A6, auto_adjusted_A6, filler_A6, trailer_A7, compartment_A7, flood_group_A7, prod_id_A7, Order_qty_A7, retained_A7, loaded_A7, returned_A7, status_A7, seal_no_A7, driver_adjusted_A7, auto_adjusted_A7, filler_A7, trailer_A8, compartment_A8, flood_group_A8, prod_id_A8, Order_qty_A8, retained_A8, loaded_A8, returned_A8, status_A8, seal_no_A8, driver_adjusted_A8, auto_adjusted_A8, filler_A8, trailer_A9, compartment_A9, flood_group_A9, prod_id_A9, Order_qty_A9, retained_A9, loaded_A9, returned_A9, status_A9, seal_no_A9, driver_adjusted_A9, auto_adjusted_A9, filler_A9, 
					   trailer_A10, compartment_A10, flood_group_A10, prod_id_A10, Order_qty_A10, retained_A10, loaded_A10, returned_A10, status_A10, seal_no_A10, driver_adjusted_A10, auto_adjusted_A10, filler_A10, trailer_A11, compartment_A11, flood_group_A11, prod_id_A11, Order_qty_A11, retained_A11, loaded_A11, returned_A11, status_A11, seal_no_A11, driver_adjusted_A11, auto_adjusted_A11, filler_A11, trailer_A12, compartment_A12, flood_group_A12, prod_id_A12, Order_qty_A12, retained_A12, loaded_A12, returned_A12, status_A12, seal_no_A12, driver_adjusted_A12, auto_adjusted_A12, filler_A12, host_order_no, sys_movement_id_A1, line_item_date_A1, line_item_time_A1, sys_movement_id_A2, line_item_date_A2, line_item_time_A2, sys_movement_id_A3, line_item_date_A3, line_item_time_A3, sys_movement_id_A4, line_item_date_A4, line_item_time_A4, sys_movement_id_A5, line_item_date_A5, line_item_time_A5, sys_movement_id_A6, line_item_date_A6, line_item_time_A6, sys_movement_id_A7, line_item_date_A7, line_item_time_A7, sys_movement_id_A8, line_item_date_A8, line_item_time_A8, sys_movement_id_A9, line_item_date_A9, line_item_time_A9, sys_movement_id_A10, line_item_date_A10, line_item_time_A10, sys_movement_id_A11, line_item_date_A11, line_item_time_A11, sys_movement_id_A12, line_item_date_A12, line_item_time_A12, limit_order, verify_carrier, sched_time, trans_id, contract_number, selected_prod_id, exp_date, exp_time, tare_wgt, folio_mo, folio_no, inv_no, host_po_number, UOM, trans_seq_no,
				       delv_zone, distance, delv_date, delv_time, load_configrmed, dispatch_customer_tupe, validate_pidx_consignee, date_added,  TmsNominationType, sequence,
					   nominationline)
				    Select @TMSFileIdnty, recdel, 'D', rec_type, supplier_no, order_no, term_id, cust_no, acct_no, destination_no, order_status, order_comments, sched_date, order_date, order_time, po_number, release_no, total_qty, driver_no, carrier_no, truck_no, trailer1, trailer2, shift, delv_seq_no, disp_comments, dest, flood_load, load_seq_no, processed, load_date, load_start, load_stop, supplier_rack_no, petroex_consignee, additional_doc, truck_driver, seal1, seal2, preload_enabled, enable_ship_to_plan, filler, trailer_A1, compartment_A1, flood_group_A1, prod_id_A1, Order_qty_A1, retained_A1, loaded_A1, returned_A1, status_A1, seal_no_A1, driver_adjusted_A1, auto_adjusted_A1, filler_A1, trailer_A2, compartment_A2, flood_group_A2, prod_id_A2, Order_qty_A2, retained_A2, loaded_A2, returned_A2, status_A2, seal_no_A2, driver_adjusted_A2, auto_adjusted_A2, filler_A2, trailer_A3, compartment_A3, flood_group_A3, prod_id_A3, Order_qty_A3, retained_A3, loaded_A3, returned_A3, status_A3, seal_no_A3, driver_adjusted_A3, auto_adjusted_A3, filler_A3,
				       trailer_A4, compartment_A4, flood_group_A4, prod_id_A4, Order_qty_A4, retained_A4, loaded_A4, returned_A4, status_A4, seal_no_A4, driver_adjusted_A4, auto_adjusted_A4, filler_A4, trailer_A5, compartment_A5, flood_group_A5, prod_id_A5, Order_qty_A5, retained_A5, loaded_A5, returned_A5, status_A5, seal_no_A5, driver_adjusted_A5, auto_adjusted_A5, filler_A5, trailer_A6, compartment_A6, flood_group_A6, prod_id_A6, Order_qty_A6, retained_A6, loaded_A6, returned_A6, status_A6, seal_no_A6, driver_adjusted_A6, auto_adjusted_A6, filler_A6, trailer_A7, compartment_A7, flood_group_A7, prod_id_A7, Order_qty_A7, retained_A7, loaded_A7, returned_A7, status_A7, seal_no_A7, driver_adjusted_A7, auto_adjusted_A7, filler_A7, trailer_A8, compartment_A8, flood_group_A8, prod_id_A8, Order_qty_A8, retained_A8, loaded_A8, returned_A8, status_A8, seal_no_A8, driver_adjusted_A8, auto_adjusted_A8, filler_A8, trailer_A9, compartment_A9, flood_group_A9, prod_id_A9, Order_qty_A9, retained_A9, loaded_A9, returned_A9, status_A9, seal_no_A9, driver_adjusted_A9, auto_adjusted_A9, filler_A9, 
					   trailer_A10, compartment_A10, flood_group_A10, prod_id_A10, Order_qty_A10, retained_A10, loaded_A10, returned_A10, status_A10, seal_no_A10, driver_adjusted_A10, auto_adjusted_A10, filler_A10, trailer_A11, compartment_A11, flood_group_A11, prod_id_A11, Order_qty_A11, retained_A11, loaded_A11, returned_A11, status_A11, seal_no_A11, driver_adjusted_A11, auto_adjusted_A11, filler_A11, trailer_A12, compartment_A12, flood_group_A12, prod_id_A12, Order_qty_A12, retained_A12, loaded_A12, returned_A12, status_A12, seal_no_A12, driver_adjusted_A12, auto_adjusted_A12, filler_A12, host_order_no, sys_movement_id_A1, line_item_date_A1, line_item_time_A1, sys_movement_id_A2, line_item_date_A2, line_item_time_A2, sys_movement_id_A3, line_item_date_A3, line_item_time_A3, sys_movement_id_A4, line_item_date_A4, line_item_time_A4, sys_movement_id_A5, line_item_date_A5, line_item_time_A5, sys_movement_id_A6, line_item_date_A6, line_item_time_A6, sys_movement_id_A7, line_item_date_A7, line_item_time_A7, sys_movement_id_A8, line_item_date_A8, line_item_time_A8, sys_movement_id_A9, line_item_date_A9, line_item_time_A9, sys_movement_id_A10, line_item_date_A10, line_item_time_A10, sys_movement_id_A11, line_item_date_A11, line_item_time_A11, sys_movement_id_A12, line_item_date_A12, line_item_time_A12, limit_order, verify_carrier, sched_time, trans_id, contract_number, selected_prod_id, exp_date, exp_time, tare_wgt, folio_mo, folio_no, inv_no, host_po_number, UOM, trans_seq_no,
				       delv_zone, distance, delv_date, delv_time, load_configrmed, dispatch_customer_tupe, validate_pidx_consignee, date_added, TmsNominationType, sequence
					   ,  recdel + 'D' + rec_type + supplier_no + order_no + term_id + cust_no + acct_no + destination_no + order_status + order_comments + sched_date + order_date + order_time + po_number + release_no + total_qty + driver_no + carrier_no + truck_no + trailer1 + trailer2 + shift + delv_seq_no + disp_comments + dest + flood_load + load_seq_no + processed + load_date + load_start + load_stop + supplier_rack_no + petroex_consignee + additional_doc + truck_driver + seal1 + seal2 + preload_enabled + enable_ship_to_plan + filler + trailer_A1 + compartment_A1 + flood_group_A1 + prod_id_A1 + Order_qty_A1 + retained_A1 + loaded_A1 + returned_A1 + status_A1 + seal_no_A1 + driver_adjusted_A1 + auto_adjusted_A1 + filler_A1 + trailer_A2 + compartment_A2 + flood_group_A2 + prod_id_A2 + Order_qty_A2 + retained_A2 + loaded_A2 + returned_A2 + status_A2 + seal_no_A2 + driver_adjusted_A2 + auto_adjusted_A2 + filler_A2 + trailer_A3 + compartment_A3 + flood_group_A3 + prod_id_A3 + Order_qty_A3 + retained_A3 + loaded_A3 + returned_A3 + status_A3 + seal_no_A3 + driver_adjusted_A3 + auto_adjusted_A3 + filler_A3 + trailer_A4 + compartment_A4 + flood_group_A4 + prod_id_A4 + Order_qty_A4 + retained_A4 + loaded_A4 + returned_A4 + status_A4 + seal_no_A4 + driver_adjusted_A4 + auto_adjusted_A4 + filler_A4 + trailer_A5 + compartment_A5 + flood_group_A5 + prod_id_A5 + Order_qty_A5 + retained_A5 + loaded_A5 + returned_A5 + status_A5 + seal_no_A5 + driver_adjusted_A5 + auto_adjusted_A5 + filler_A5 + trailer_A6 + compartment_A6 + flood_group_A6 + prod_id_A6 + Order_qty_A6 + retained_A6 + loaded_A6 + returned_A6 + status_A6 + seal_no_A6 + driver_adjusted_A6 + auto_adjusted_A6 + filler_A6 + trailer_A7 + compartment_A7 + flood_group_A7 + prod_id_A7 + Order_qty_A7 + retained_A7 + loaded_A7 + returned_A7 + status_A7 + seal_no_A7 + driver_adjusted_A7 + auto_adjusted_A7 + filler_A7 + trailer_A8 + compartment_A8 + flood_group_A8 + prod_id_A8 + Order_qty_A8 + retained_A8 + loaded_A8 + returned_A8 + status_A8 + seal_no_A8 + driver_adjusted_A8 + auto_adjusted_A8 + filler_A8 + trailer_A9 + compartment_A9 + flood_group_A9 + prod_id_A9 + Order_qty_A9 + retained_A9 + loaded_A9 + returned_A9 + status_A9 + seal_no_A9 + driver_adjusted_A9 + auto_adjusted_A9 + filler_A9 + trailer_A10 + compartment_A10 + flood_group_A10 + prod_id_A10 + Order_qty_A10 + retained_A10 + loaded_A10 + returned_A10 + status_A10 + seal_no_A10 + driver_adjusted_A10 + auto_adjusted_A10 + filler_A10 + trailer_A11 + compartment_A11 + flood_group_A11 + prod_id_A11 + Order_qty_A11 + retained_A11 + loaded_A11 + returned_A11 + status_A11 + seal_no_A11 + driver_adjusted_A11 + auto_adjusted_A11 + filler_A11 + trailer_A12 + compartment_A12 + flood_group_A12 + prod_id_A12 + Order_qty_A12 + retained_A12 + loaded_A12 + returned_A12 + status_A12 + seal_no_A12 + driver_adjusted_A12 + auto_adjusted_A12 + filler_A12 + host_order_no + sys_movement_id_A1 + line_item_date_A1 + line_item_time_A1 + sys_movement_id_A2 + line_item_date_A2 + line_item_time_A2 + sys_movement_id_A3 + line_item_date_A3 + line_item_time_A3 + sys_movement_id_A4 + line_item_date_A4 + line_item_time_A4 + sys_movement_id_A5 + line_item_date_A5 + line_item_time_A5 + sys_movement_id_A6 + line_item_date_A6 + line_item_time_A6 + sys_movement_id_A7 + line_item_date_A7 + line_item_time_A7 + sys_movement_id_A8 + line_item_date_A8 + line_item_time_A8 + sys_movement_id_A9 + line_item_date_A9 + line_item_time_A9 + sys_movement_id_A10 + line_item_date_A10 + line_item_time_A10 + sys_movement_id_A11 + line_item_date_A11 + line_item_time_A11 + sys_movement_id_A12 + line_item_date_A12 + line_item_time_A12 + limit_order + verify_carrier + sched_time + trans_id + contract_number + selected_prod_id + exp_date + exp_time + tare_wgt + folio_mo + folio_no + inv_no + host_po_number + UOM + trans_seq_no + delv_zone + distance + delv_date + delv_time + load_configrmed + dispatch_customer_tupe + validate_pidx_consignee + date_added

				    From dbo.MTVTMSNominationStaging MA
				    Where MA.TMSFileIdnty = @LastTMSFileIdnty
					  and isnull(MA.sequence,1) = isnull(@sequence,1)
  				      and MA.Action <> 'D'
				    set @rowcount = @@rowcount

		    	   end

      			  select @sequence =  min( sequence ) from dbo.MTVTMSNominationStaging where sequence > @sequence  and order_no  in (select plnndmvtid from dbo.MTVTMSAccountToTmsStaging where TMSFileIdnty = @TMSFileIdnty )

			  end
				

				return isnull(@rowcount,0)


GO






if OBJECT_ID('sp_MTVTMSNominationCheckForUpdateToKeyColumns')is not null begin
   --print '<< Procedure sp_MTVTMSNominationCheckForUpdateToKeyColumns created >>>'
   grant execute on sp_MTVTMSNominationCheckForUpdateToKeyColumns to sysuser, RightAngleAccess
end
else
   print '<<<< Creation of procedure sp_MTVTMSNominationCheckForUpdateToKeyColumns failed >>>'


   go